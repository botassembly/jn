#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.9"
# dependencies = [
#   "jsonschema>=4.0.0",
# ]
# ///
"""Test plugin tool - validates plugin structure and runs tests.

This is a standalone tool with its own dependencies (jsonschema).
The main JN project stays dependency-free (just click).

Usage:
    jn-test-plugin path/to/plugin.py
    jn-test-plugin path/to/plugin.py --verbose
    jn-test-plugin path/to/plugin.py --schema-only
"""

import sys
import json
import importlib.util
from pathlib import Path
from io import StringIO
from typing import Any, Optional


def load_plugin(plugin_path: Path):
    """Load a plugin module from file path."""
    spec = importlib.util.spec_from_file_location("plugin", plugin_path)
    if spec is None or spec.loader is None:
        print(f"Error: Could not load plugin from {plugin_path}", file=sys.stderr)
        sys.exit(1)

    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)
    return module


def validate_schema(record: dict, schema: dict) -> tuple[bool, Optional[str]]:
    """Validate record against JSON schema."""
    try:
        import jsonschema
        jsonschema.validate(record, schema)
        return True, None
    except jsonschema.ValidationError as e:
        return False, str(e)


def matches_shape(actual: Any, expected: Any, ignore_fields: set = None) -> bool:
    """Check if actual matches expected shape, ignoring dynamic fields.

    Args:
        actual: Actual value from plugin
        expected: Expected shape/structure
        ignore_fields: Field names to ignore (timestamps, IPs, etc.)

    Returns:
        True if shapes match
    """
    ignore_fields = ignore_fields or set()

    # Type must match
    if type(actual) != type(expected):
        return False

    # For dicts, check structure
    if isinstance(expected, dict):
        for key in expected:
            if key in ignore_fields:
                continue
            if key not in actual:
                return False
            if not matches_shape(actual[key], expected[key], ignore_fields):
                return False
        return True

    # For lists, check first element shape
    if isinstance(expected, list) and len(expected) > 0:
        if len(actual) == 0:
            return True  # Empty list is valid
        # Check first item matches expected shape
        return matches_shape(actual[0], expected[0], ignore_fields)

    # Primitives - type match is enough
    return True


def run_plugin_tests(plugin_path: Path, verbose: bool = False, schema_only: bool = False) -> bool:
    """Run tests for a plugin.

    Args:
        plugin_path: Path to plugin file
        verbose: Print detailed output
        schema_only: Only validate schema, don't run tests

    Returns:
        True if all tests pass
    """
    # Load plugin
    try:
        plugin = load_plugin(plugin_path)
    except Exception as e:
        print(f"Error loading plugin: {e}", file=sys.stderr)
        return False

    # Check required functions
    if not hasattr(plugin, 'run'):
        print("Error: Plugin missing run() function", file=sys.stderr)
        return False

    if not hasattr(plugin, 'examples'):
        print("Error: Plugin missing examples() function", file=sys.stderr)
        return False

    # Get schema if available
    schema = None
    if hasattr(plugin, 'schema'):
        try:
            schema = plugin.schema()
            if verbose:
                print(f"\nPlugin schema:", file=sys.stderr)
                print(json.dumps(schema, indent=2), file=sys.stderr)
        except Exception as e:
            print(f"Warning: Could not get schema: {e}", file=sys.stderr)

    if schema_only:
        if schema:
            print(json.dumps(schema, indent=2))
            return True
        else:
            print("Error: Plugin has no schema() function", file=sys.stderr)
            return False

    # Get test cases
    try:
        test_cases = plugin.examples()
    except Exception as e:
        print(f"Error getting examples: {e}", file=sys.stderr)
        return False

    if not test_cases:
        print("Warning: No test cases defined", file=sys.stderr)
        return True

    # Run tests
    passed = 0
    failed = 0

    for i, test_case in enumerate(test_cases, 1):
        desc = test_case.get('description', f'Test {i}')
        test_input = test_case.get('input', '')
        expected = test_case.get('expected', [])
        config = test_case.get('config', {})
        ignore_fields = set(test_case.get('ignore_fields', []))

        # Mock stdin
        old_stdin = sys.stdin
        sys.stdin = StringIO(test_input)

        try:
            # Run plugin
            results = list(plugin.run(config))

            # If expected is empty, just validate schema (for variable output commands)
            if not expected:
                test_passed = True

                # Ensure we got results
                if len(results) == 0:
                    if verbose:
                        print(f"✗ Test {i}: {desc} - No results", file=sys.stderr)
                    failed += 1
                    sys.stdin = old_stdin
                    continue

                # Schema validation only
                if schema:
                    for j, record in enumerate(results):
                        valid, error = validate_schema(record, schema)
                        if not valid:
                            if verbose:
                                print(f"✗ Test {i}: {desc}", file=sys.stderr)
                                print(f"  Record {j} schema validation failed:", file=sys.stderr)
                                print(f"  {error}", file=sys.stderr)
                            test_passed = False
                            break

                if test_passed:
                    if verbose:
                        print(f"✓ Test {i}: {desc} ({len(results)} records, schema valid)", file=sys.stderr)
                    passed += 1
                else:
                    failed += 1

                sys.stdin = old_stdin
                continue

            # Check result count
            if len(results) != len(expected):
                if verbose:
                    print(f"✗ Test {i}: {desc}", file=sys.stderr)
                    print(f"  Expected {len(expected)} records, got {len(results)}", file=sys.stderr)
                failed += 1
                sys.stdin = old_stdin
                continue

            # Validate each record
            test_passed = True

            # Schema validation
            if schema:
                for j, record in enumerate(results):
                    valid, error = validate_schema(record, schema)
                    if not valid:
                        if verbose:
                            print(f"✗ Test {i}: {desc}", file=sys.stderr)
                            print(f"  Record {j} schema validation failed:", file=sys.stderr)
                            print(f"  {error}", file=sys.stderr)
                        test_passed = False
                        break

            # Shape matching (ignoring dynamic fields)
            if test_passed:
                for j, (result, exp) in enumerate(zip(results, expected)):
                    if not matches_shape(result, exp, ignore_fields):
                        if verbose:
                            print(f"✗ Test {i}: {desc}", file=sys.stderr)
                            print(f"  Record {j} shape mismatch", file=sys.stderr)
                            print(f"  Expected: {exp}", file=sys.stderr)
                            print(f"  Got: {result}", file=sys.stderr)
                        test_passed = False
                        break

            if test_passed:
                if verbose:
                    print(f"✓ Test {i}: {desc}", file=sys.stderr)
                passed += 1
            else:
                failed += 1

        except Exception as e:
            if verbose:
                print(f"✗ Test {i}: {desc}", file=sys.stderr)
                print(f"  Error: {e}", file=sys.stderr)
            failed += 1

        finally:
            sys.stdin = old_stdin

    # Summary
    total = passed + failed
    if verbose or failed > 0:
        print(f"\n{passed}/{total} tests passed", file=sys.stderr)

    return failed == 0


def main():
    """Main entry point."""
    import argparse

    parser = argparse.ArgumentParser(
        description='Test JN plugins with schema validation'
    )
    parser.add_argument(
        'plugin',
        type=Path,
        help='Path to plugin file'
    )
    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='Print detailed output'
    )
    parser.add_argument(
        '--schema-only',
        action='store_true',
        help='Only print schema, do not run tests'
    )

    args = parser.parse_args()

    if not args.plugin.exists():
        print(f"Error: Plugin file not found: {args.plugin}", file=sys.stderr)
        sys.exit(1)

    success = run_plugin_tests(args.plugin, args.verbose, args.schema_only)
    sys.exit(0 if success else 1)


if __name__ == '__main__':
    main()
